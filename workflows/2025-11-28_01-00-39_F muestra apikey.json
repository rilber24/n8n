{
  "updatedAt": "2025-09-03T03:23:17.000Z",
  "createdAt": "2025-09-03T02:26:54.555Z",
  "id": "CedkqCXHsIeqqdV0",
  "name": "F muestra apikey",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "custom",
              "cronExpression": "10 22 * * *"
            }
          ]
        }
      },
      "id": "50a601fb-f109-42be-8a0b-34815e657c5e",
      "name": "Cron 22:10",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [
        48,
        64
      ]
    },
    {
      "parameters": {},
      "id": "26967def-ad1d-4fa5-a272-f1da5c90e349",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        48,
        304
      ]
    },
    {
      "parameters": {
        "mode": "passThrough"
      },
      "id": "42bc4099-553b-484b-9d0b-7a542ff1bc14",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 1,
      "position": [
        288,
        176
      ]
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "modo",
              "value": "text"
            },
            {
              "name": "message",
              "value": "ðŸ“£ Comunicado Ã¡rea 3: reuniÃ³n 10:30."
            },
            {
              "name": "mediaUrl"
            },
            {
              "name": "fileName",
              "value": "aviso.pdf"
            },
            {
              "name": "operatorTo",
              "value": "59172896612"
            },
            {
              "name": "overrideTo"
            },
            {
              "name": "evBase",
              "value": "{{$env.EV_BASE_URL}}"
            },
            {
              "name": "evInstance",
              "value": "{{$env.EV_INSTANCE}}"
            },
            {
              "name": "evApikey",
              "value": "{{$env.EV_APIKEY}}"
            }
          ],
          "number": [
            {
              "name": "areaId",
              "value": 3
            },
            {
              "name": "batchSize",
              "value": 25
            },
            {
              "name": "delaySeconds",
              "value": 0.6
            }
          ],
          "boolean": [
            {
              "name": "verifyNumber"
            }
          ]
        },
        "options": {}
      },
      "id": "af188066-a3ba-4aa0-af36-edc6cc2119ce",
      "name": "Set Params",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        528,
        176
      ]
    },
    {
      "parameters": {
        "url": "={{ 'https://apirrhh.envibol.site/api/v1/N8n/GetUnidad/' + $json[\"areaId\"] }}",
        "options": {}
      },
      "id": "341483e2-d908-41ea-91db-a9b310eea284",
      "name": "HTTP GetUnidad",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        768,
        176
      ]
    },
    {
      "parameters": {
        "functionCode": "/**\n * Function Expand (con placeholders y fix para leer Set Params)\n * Soporta: {{fullName}}, {{nombre}}, {{apellidoPaterno}}, {{apellidoMaterno}}, {{ci}}, {{areaId}}\n */\n\nconst input = $json;  // payload del HTTP GetUnidad\n\n// === tomar los parÃ¡metros del nodo \"Set Params\" ===\n// OJO: si renombraste el nodo, cambia el string aquÃ­ abajo:\nconst setParamsItems = $items('Set Params', 0, 0);\nif (!setParamsItems?.[0]?.json) {\n  throw new Error('No encuentro datos del nodo \"Set Params\". Verifica el nombre y la conexiÃ³n.');\n}\nconst p = setParamsItems[0].json;\n\n// --- helpers ---\nconst onlyDigits = (s) => String(s ?? '').replace(/\\D/g, '');\nconst toE164BO = (raw) => {\n  let n = onlyDigits(raw);\n  if (!n) return null;\n  if (/^591\\d{8}$/.test(n)) return n;           // 591 + 8 dÃ­gitos\n  if (/^7\\d{8}$/.test(n))  return '591' + n;    // 7 + 8 dÃ­gitos (mÃ³vil BO)\n  if (/^\\d{8}$/.test(n))   return '591' + n;    // 8 dÃ­gitos\n  const mm = n.match(/591\\d{8}/);\n  return mm ? mm[0] : null;\n};\n\n// motor de plantilla {{campo}}\nfunction render(tpl, ctx) {\n  return String(tpl ?? '').replace(/{{\\s*([\\w.]+)\\s*}}/g, (_, key) => {\n    const v = key.split('.').reduce((acc,k)=> (acc && acc[k] !== undefined) ? acc[k] : '', ctx);\n    return (v === null || v === undefined) ? '' : String(v);\n  }).replace(/\\s+/g,' ').trim();\n}\n\nif (input.succeeded === false) {\n  throw new Error(`API GetUnidad fallÃ³: ${input.message || 'sin mensaje'}`);\n}\n\n// soporta que el HTTP devuelva {data:[...]} o directamente [...]\nconst personas = Array.isArray(input?.data) ? input.data\n               : Array.isArray(input)       ? input\n               : [];\n\nconst seen = new Set();\nlet recipients = [];\n\nfor (const person of personas) {\n  const num = toE164BO(person.celular);\n  if (!num || seen.has(num)) continue;\n  seen.add(num);\n\n  const fullName = [person.nombre, person.apellidoPaterno, person.apellidoMaterno]\n    .filter(Boolean).join(' ').replace(/\\s+/g,' ').trim();\n\n  const ctx = { ...person, fullName, areaId: p.areaId };\n\n  let msg = render(p.message, ctx);  // ejemplo: \"Hola, {{fullName}}: â€¦\"\n  if (p.overrideTo && String(p.overrideTo).trim()) {\n    msg = `[TEST â€” Ãrea ${p.areaId}] ${msg}`;\n  }\n\n  recipients.push({\n    json: {\n      to: (p.overrideTo && String(p.overrideTo).trim()) ? onlyDigits(p.overrideTo) : num,\n      modo: p.modo,                    // \"text\" | \"image\" | \"document\"\n      message: msg,\n      mediaUrl: p.mediaUrl || '',\n      fileName: p.fileName || 'adjunto.pdf',\n\n      // Evolution desde Set Params (vÃ­a ENV)\n      evBase: p.evBase,\n      evInstance: p.evInstance,\n      evApikey: p.evApikey,\n\n      operatorTo: p.operatorTo,\n      delaySeconds: p.delaySeconds,\n      areaId: p.areaId,\n\n      fullName,\n      ci: person.ci ?? null,\n    }\n  });\n}\n\n// mÃ©tricas de campaÃ±a\nconst store = this.getWorkflowStaticData('global');\nstore.broadcast ??= {};\nconst broadcastId = `b_${Date.now()}`;\nstore.broadcast[broadcastId] = {\n  areaId: p.areaId,\n  total: recipients.length,\n  sent: 0,\n  failed: 0,\n  invalid: 0,\n  startedAt: new Date().toISOString(),\n};\n\n// adjuntar id a cada item\nreturn recipients.map(it => ({ json: { ...it.json, broadcastId } }));"
      },
      "id": "f4a1f139-8db5-4237-9aea-6d7a6adf5887",
      "name": "Function Expand",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1008,
        176
      ]
    },
    {
      "parameters": {
        "batchSize": "={{$prevNode['Set Params'].json.batchSize}}",
        "options": {}
      },
      "id": "739386cd-e5b1-400d-8a91-e18e12ce68b1",
      "name": "Split In Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 1,
      "position": [
        1248,
        176
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.modo}}",
              "value2": "text"
            }
          ]
        }
      },
      "id": "990fc073-fc13-42d5-83b9-4a5b9a66761b",
      "name": "IF Text",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1488,
        80
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.modo}}",
              "value2": "image"
            }
          ]
        }
      },
      "id": "880e924c-381b-4663-8944-7ccae40fa365",
      "name": "IF Image",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1488,
        176
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.modo}}",
              "value2": "document"
            }
          ]
        }
      },
      "id": "74f1355d-8a31-4867-8bca-81f319972725",
      "name": "IF Document",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1488,
        272
      ]
    },
    {
      "parameters": {
        "url": "={{$json.evBase}}/message/sendText/{{$json.evInstance}}?apikey={{$json.evApikey}}",
        "jsonParameters": true,
        "options": {}
      },
      "id": "1e88d5bf-41a9-4607-885c-903be89495d7",
      "name": "Send Text (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1728,
        80
      ]
    },
    {
      "parameters": {
        "url": "={{$json.evBase}}/message/sendImage/{{$json.evInstance}}?apikey={{$json.evApikey}}",
        "jsonParameters": true,
        "options": {}
      },
      "id": "73c147fd-ccc6-42f2-a978-3183f6c85feb",
      "name": "Send Image (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1728,
        176
      ]
    },
    {
      "parameters": {
        "url": "={{$json.evBase}}/message/sendFile/{{$json.evInstance}}?apikey={{$json.evApikey}}",
        "jsonParameters": true,
        "options": {}
      },
      "id": "c1db3a11-b96e-4d87-9857-4a3ddb0187ab",
      "name": "Send Document (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1728,
        272
      ]
    },
    {
      "parameters": {
        "functionCode": "\nconst store = this.getWorkflowStaticData('global');\nconst id = $json.broadcastId;\nconst ok = ($json.statusCode === undefined) || ($json.statusCode >= 200 && $json.statusCode < 300);\nif (ok) store.broadcast[id].sent++;\nelse store.broadcast[id].failed++;\nreturn items;\n"
      },
      "id": "a0c0d119-66f1-4ff1-90ac-85239a2de435",
      "name": "Function Tally",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1968,
        176
      ]
    },
    {
      "parameters": {
        "amount": "={{$json.delaySeconds || 0.6}}",
        "unit": "seconds"
      },
      "id": "058e204d-3ef5-4327-8205-bc5e97410f16",
      "name": "Wait",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        2208,
        176
      ],
      "webhookId": "15610dd3-7f3c-44e2-bdfa-c3cbe9737404"
    },
    {
      "parameters": {
        "functionCode": "\nconst store = this.getWorkflowStaticData('global');\nconst keys = Object.keys(store.broadcast || {});\nif (!keys.length) {\n  return [{ json: { to: $prevNode[\"Set Params\"].json.operatorTo, message: \"No hay mÃ©tricas registradas.\" } }];\n}\nconst id = keys.sort().slice(-1)[0];\nconst m = store.broadcast[id];\n\nm.finishedAt = new Date().toISOString();\nm.durationSec = Math.round((new Date(m.finishedAt) - new Date(m.startedAt)) / 1000);\n\nconst summary =\n  `ðŸ“Š *Resumen envÃ­o Ã¡rea ${m.areaId}*\\\\n` +\n  `â€¢ Total destinatarios: ${m.total}\\\\n` +\n  `â€¢ Enviados OK: ${m.sent}\\\\n` +\n  `â€¢ InvÃ¡lidos: ${m.invalid}\\\\n` +\n  `â€¢ Fallidos: ${m.failed}\\\\n` +\n  `â€¢ DuraciÃ³n: ${m.durationSec}s\\\\n` +\n  `â€¢ ID: ${id}`;\n\nreturn [{ json: { to: $prevNode[\"Set Params\"].json.operatorTo, message: summary } }];\n"
      },
      "id": "a1bf514f-7270-4c63-98cd-ce4268489d64",
      "name": "Function Build Summary",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1488,
        432
      ]
    },
    {
      "parameters": {
        "url": "={{$prevNode['Set Params'].json.evBase}}/message/sendText/{{$prevNode['Set Params'].json.evInstance}}?apikey={{$prevNode['Set Params'].json.evApikey}}",
        "jsonParameters": true,
        "options": {}
      },
      "id": "55f2a222-ae25-4f68-a4c4-cdf0177ef16f",
      "name": "Send Summary (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1728,
        432
      ]
    },
    {
      "parameters": {
        "functionCode": "const s=this.getWorkflowStaticData('global'); s.broadcast={}; return items;"
      },
      "id": "f0e516c2-aade-49ad-86fd-dfe7b75bbe1e",
      "name": "Function Cleanup",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1968,
        432
      ]
    }
  ],
  "connections": {
    "Cron 22:10": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Triggers": {
      "main": [
        [
          {
            "node": "Set Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Params": {
      "main": [
        [
          {
            "node": "HTTP GetUnidad",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP GetUnidad": {
      "main": [
        [
          {
            "node": "Function Expand",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function Expand": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split In Batches": {
      "main": [
        [
          {
            "node": "IF Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Text": {
      "main": [
        [
          {
            "node": "Send Text (HTTP)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Image": {
      "main": [
        [
          {
            "node": "Send Image (HTTP)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF Document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Document": {
      "main": [
        [
          {
            "node": "Send Document (HTTP)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Text (HTTP)": {
      "main": [
        [
          {
            "node": "Function Tally",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Image (HTTP)": {
      "main": [
        [
          {
            "node": "Function Tally",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Document (HTTP)": {
      "main": [
        [
          {
            "node": "Function Tally",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function Tally": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function Build Summary": {
      "main": [
        [
          {
            "node": "Send Summary (HTTP)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Summary (HTTP)": {
      "main": [
        [
          {
            "node": "Function Cleanup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "7ec1030f-335e-47e5-80ce-4a6ee27177d4",
  "triggerCount": 0,
  "shared": [
    {
      "updatedAt": "2025-09-03T02:26:54.562Z",
      "createdAt": "2025-09-03T02:26:54.562Z",
      "role": "workflow:owner",
      "workflowId": "CedkqCXHsIeqqdV0",
      "projectId": "DLCF6dMNvaWDIOVx"
    }
  ],
  "tags": []
}