{
  "updatedAt": "2025-09-03T02:26:31.000Z",
  "createdAt": "2025-09-03T02:02:50.471Z",
  "id": "S5kdugYsyR8FJepw",
  "name": "My workflow 11",
  "active": false,
  "isArchived": true,
  "nodes": [
    {
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "custom",
              "cronExpression": "0 8 * * *"
            }
          ]
        }
      },
      "id": "33a0d1b0-79f4-4e54-8f5e-073a0902d169",
      "name": "Cron 08:00",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {},
      "id": "4e728f70-9c49-45c3-8b7e-3f289590e18e",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        0,
        240
      ]
    },
    {
      "parameters": {
        "mode": "passThrough"
      },
      "id": "71e450d9-16cf-4ed3-bdd8-f617e82343c2",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 1,
      "position": [
        240,
        128
      ]
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "modo",
              "value": "text"
            },
            {
              "name": "message",
              "value": "ðŸ“£ Comunicado Ã¡rea 3: reuniÃ³n 10:30."
            },
            {
              "name": "mediaUrl"
            },
            {
              "name": "fileName",
              "value": "aviso.pdf"
            },
            {
              "name": "operatorTo",
              "value": "5917XXXXXXXX"
            },
            {
              "name": "overrideTo"
            },
            {
              "name": "EVOLUTION_BASE_URL",
              "value": "https://YOUR-EVOLUTION"
            },
            {
              "name": "EVOLUTION_TOKEN",
              "value": "YOUR_TOKEN"
            }
          ],
          "number": [
            {
              "name": "areaId",
              "value": 3
            },
            {
              "name": "batchSize",
              "value": 25
            },
            {
              "name": "delaySeconds",
              "value": 0.3
            }
          ],
          "boolean": [
            {
              "name": "verifyNumber"
            }
          ]
        },
        "options": {}
      },
      "id": "f741b083-6ad3-4f36-9e7f-3e95eaf7aa47",
      "name": "Set Params",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        480,
        128
      ]
    },
    {
      "parameters": {
        "url": "https://apirrhh.envibol.site/api/v1/N8n/GetUnidad/{{$json.areaId}}",
        "options": {}
      },
      "id": "77510139-6a18-404d-bb45-08a5586b4746",
      "name": "HTTP GetUnidad",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        720,
        128
      ]
    },
    {
      "parameters": {
        "functionCode": "\nconst personas = $json.data || [];\nconst p = $prevNode[\"Set Params\"].json;\n\nconst e164 = s => String(s||'').replace(/\\D/g,'');\n\nlet recipients = personas\n  .filter(x => x.celular)\n  .map(x => ({\n    to: e164(x.celular),\n    modo: p.modo,\n    message: p.message,\n    mediaUrl: p.mediaUrl || '',\n    fileName: p.fileName || 'adjunto.pdf',\n    EVOLUTION_BASE_URL: p.EVOLUTION_BASE_URL,\n    EVOLUTION_TOKEN: p.EVOLUTION_TOKEN,\n    operatorTo: p.operatorTo,\n    delaySeconds: p.delaySeconds\n  }));\n\nif ((p.overrideTo || '').trim()) {\n  recipients = [{\n    to: e164(p.overrideTo),\n    modo: p.modo,\n    message: `[TEST â€” Ãrea ${p.areaId}] ${p.message}`,\n    mediaUrl: p.mediaUrl || '',\n    fileName: p.fileName || 'adjunto.pdf',\n    EVOLUTION_BASE_URL: p.EVOLUTION_BASE_URL,\n    EVOLUTION_TOKEN: p.EVOLUTION_TOKEN,\n    operatorTo: p.operatorTo,\n    delaySeconds: p.delaySeconds\n  }];\n}\n\nconst store = this.getWorkflowStaticData('global');\nstore.broadcast = store.broadcast || {};\nconst broadcastId = `b_${Date.now()}`;\nstore.broadcast[broadcastId] = { sent:0, failed:0, invalid:0, total: recipients.length, areaId: p.areaId, startedAt: new Date().toISOString() };\n\nreturn recipients.map(r => ({ json: { ...r, broadcastId } }));\n"
      },
      "id": "d606a8b1-f6a8-4aad-b7c5-b6c661589239",
      "name": "Function Expand",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        960,
        128
      ]
    },
    {
      "parameters": {
        "batchSize": "={{$prevNode['Set Params'].json.batchSize}}",
        "options": {}
      },
      "id": "59c834eb-7ff3-4713-8b04-32fc815fd78b",
      "name": "Split In Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 1,
      "position": [
        1200,
        128
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.modo}}",
              "value2": "text"
            }
          ]
        }
      },
      "id": "5ff7d974-ff34-487b-a15c-43ffe9b0c970",
      "name": "IF Text",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1440,
        32
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.modo}}",
              "value2": "image"
            }
          ]
        }
      },
      "id": "6660fddb-f535-42e7-b9a6-57d25f0bf234",
      "name": "IF Image",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1440,
        128
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.modo}}",
              "value2": "document"
            }
          ]
        }
      },
      "id": "d662fddc-dd35-4962-92d7-47a5d0c2547e",
      "name": "IF Document",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1440,
        224
      ]
    },
    {
      "parameters": {
        "url": "={{$json.EVOLUTION_BASE_URL}}/send-text?token={{$json.EVOLUTION_TOKEN}}",
        "jsonParameters": true,
        "options": {}
      },
      "id": "a6e04dff-6652-4203-a90d-d070c5ade984",
      "name": "Send Text (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1680,
        32
      ]
    },
    {
      "parameters": {
        "url": "={{$json.EVOLUTION_BASE_URL}}/send-image?token={{$json.EVOLUTION_TOKEN}}",
        "jsonParameters": true,
        "options": {}
      },
      "id": "92873ebb-b5f9-4957-a38c-1273d935c658",
      "name": "Send Image (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1680,
        128
      ]
    },
    {
      "parameters": {
        "url": "={{$json.EVOLUTION_BASE_URL}}/send-document?token={{$json.EVOLUTION_TOKEN}}",
        "jsonParameters": true,
        "options": {}
      },
      "id": "13116474-4ea9-417b-8412-9fba7000688d",
      "name": "Send Document (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1680,
        224
      ]
    },
    {
      "parameters": {
        "functionCode": "\nconst store = this.getWorkflowStaticData('global');\nconst id = $json.broadcastId;\nconst ok = ($json.statusCode === undefined) || ($json.statusCode >= 200 && $json.statusCode < 300);\nif (ok) store.broadcast[id].sent++;\nelse store.broadcast[id].failed++;\nreturn items;\n"
      },
      "id": "746c377f-3e19-477a-b966-7f6fa6fe0168",
      "name": "Function Tally",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1920,
        128
      ]
    },
    {
      "parameters": {
        "amount": "={{$json.delaySeconds || 0.3}}",
        "unit": "seconds"
      },
      "id": "af5553af-621a-41dd-9c26-504caba34552",
      "name": "Wait",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        2160,
        128
      ],
      "webhookId": "154d9dd5-1a84-41f6-b2dc-dac111557aba"
    },
    {
      "parameters": {
        "functionCode": "\nconst store = this.getWorkflowStaticData('global');\nconst keys = Object.keys(store.broadcast || {});\nif (!keys.length) {\n  return [{ json: { to: $prevNode[\"Set Params\"].json.operatorTo, message: \"No hay mÃ©tricas registradas.\" } }];\n}\nconst id = keys.sort().slice(-1)[0];\nconst m = store.broadcast[id];\n\nm.finishedAt = new Date().toISOString();\nm.durationSec = Math.round((new Date(m.finishedAt) - new Date(m.startedAt)) / 1000);\n\nconst summary =\n  `ðŸ“Š *Resumen envÃ­o Ã¡rea ${m.areaId}*\\\\n` +\n  `â€¢ Total destinatarios: ${m.total}\\\\n` +\n  `â€¢ Enviados OK: ${m.sent}\\\\n` +\n  `â€¢ InvÃ¡lidos: ${m.invalid}\\\\n` +\n  `â€¢ Fallidos: ${m.failed}\\\\n` +\n  `â€¢ DuraciÃ³n: ${m.durationSec}s\\\\n` +\n  `â€¢ ID: ${id}`;\n\nreturn [{ json: { to: $prevNode[\"Set Params\"].json.operatorTo, message: summary } }];\n"
      },
      "id": "c5d7942a-8245-44af-8d33-69e34d9d044d",
      "name": "Function Build Summary",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1440,
        384
      ]
    },
    {
      "parameters": {
        "url": "={{$prevNode['Set Params'].json.EVOLUTION_BASE_URL}}/send-text?token={{$prevNode['Set Params'].json.EVOLUTION_TOKEN}}",
        "jsonParameters": true,
        "options": {}
      },
      "id": "5c943651-655a-4d2a-a98e-99d6661dd021",
      "name": "Send Summary (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1680,
        384
      ]
    },
    {
      "parameters": {
        "functionCode": "const s=this.getWorkflowStaticData('global'); s.broadcast={}; return items;"
      },
      "id": "5d596ffc-36ff-48ab-9085-b9145d0ca31b",
      "name": "Function Cleanup",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1920,
        384
      ]
    }
  ],
  "connections": {
    "Cron 08:00": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Triggers": {
      "main": [
        [
          {
            "node": "Set Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Params": {
      "main": [
        [
          {
            "node": "HTTP GetUnidad",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP GetUnidad": {
      "main": [
        [
          {
            "node": "Function Expand",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function Expand": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split In Batches": {
      "main": [
        [
          {
            "node": "IF Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Text": {
      "main": [
        [
          {
            "node": "Send Text (HTTP)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Image": {
      "main": [
        [
          {
            "node": "Send Image (HTTP)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF Document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Document": {
      "main": [
        [
          {
            "node": "Send Document (HTTP)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Text (HTTP)": {
      "main": [
        [
          {
            "node": "Function Tally",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Image (HTTP)": {
      "main": [
        [
          {
            "node": "Function Tally",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Document (HTTP)": {
      "main": [
        [
          {
            "node": "Function Tally",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function Tally": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function Build Summary": {
      "main": [
        [
          {
            "node": "Send Summary (HTTP)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Summary (HTTP)": {
      "main": [
        [
          {
            "node": "Function Cleanup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "a0070dcc-470d-4e0a-a375-b655c2dcc4f6",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-09-03T02:02:50.477Z",
      "createdAt": "2025-09-03T02:02:50.477Z",
      "role": "workflow:owner",
      "workflowId": "S5kdugYsyR8FJepw",
      "projectId": "DLCF6dMNvaWDIOVx"
    }
  ],
  "tags": []
}