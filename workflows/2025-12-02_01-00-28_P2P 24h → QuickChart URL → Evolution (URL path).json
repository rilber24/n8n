{
  "updatedAt": "2025-10-01T21:26:45.000Z",
  "createdAt": "2025-10-01T21:15:06.429Z",
  "id": "8X2u0acz0kF9LKrz",
  "name": "P2P 24h â†’ QuickChart URL â†’ Evolution (URL path)",
  "active": false,
  "isArchived": true,
  "nodes": [
    {
      "parameters": {},
      "id": "8563c053-1811-4916-bdb4-ed5394f77ab7",
      "name": "ğŸ•’ Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -768,
        144
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT 'Compra' AS serie, fecha_hora, precio\nFROM compra_bob\nWHERE fecha_hora >= '{{$json[\"startLocal\"]}}'\n  AND fecha_hora <= '{{$json[\"endLocal\"]}}'\nUNION ALL\nSELECT 'Venta'  AS serie, fecha_hora, precio\nFROM venta_bob\nWHERE fecha_hora >= '{{$json[\"startLocal\"]}}'\n  AND fecha_hora <= '{{$json[\"endLocal\"]}}'\nORDER BY fecha_hora ASC;"
      },
      "id": "150d9edc-bdb4-43c5-9802-8af54f32461e",
      "name": "ğŸ—„ï¸ MySQL â€“ Leer P2P 24h",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 1,
      "position": [
        -480,
        144
      ],
      "credentials": {
        "mySql": {
          "id": "E3NXQrJaLGKMyUsb",
          "name": "MySQL account"
        }
      },
      "notes": "Ajusta la consulta a tu esquema. Idealmente datos en UTC.\nSi tienes una sola tabla con columna 'serie', usa esa."
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "caption",
              "value": "={{$json[\"caption\"]}}"
            }
          ]
        },
        "options": {}
      },
      "id": "6343c5b9-828b-438c-b24d-4beec0e46d80",
      "name": "ğŸ§¾ Set â€“ Caption (pass-through)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        0,
        304
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://quickchart.io/chart/create",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "options": {
          "timeout": 60000
        }
      },
      "id": "5d588974-3e36-487a-bdef-4d4f30903136",
      "name": "ğŸ”— HTTP â€“ QuickChart /chart/create (short URL)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "mode": "mergeByIndex",
        "options": {}
      },
      "id": "74f799e4-4566-4d5c-82fd-a5c9ce9402ea",
      "name": "ğŸ”€ Merge â€“ URL + Caption",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        224,
        144
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://{{$env.EV_SERVER_URL}}/message/sendMedia/{{$env.EV_INSTANCE}}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "options": {
          "timeout": 60000
        }
      },
      "id": "14755774-7754-42ab-a138-1cb15ef61732",
      "name": "ğŸ“¨ HTTP â€“ Evolution sendMedia (URL)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        448,
        144
      ]
    },
    {
      "parameters": {
        "jsCode": "// items: [{ json: { serie, fecha_hora, precio } }, ...]\nconst tz = 'America/La_Paz';\nconst end = new Date(); end.setSeconds(0,0);\nconst start = new Date(end.getTime() - 24*3600*1000); start.setSeconds(0,0);\nconst fmt = (d) => d.toLocaleString('es-BO', { timeZone: tz });\n\nconst compra = [], venta = [];\nconst toTs = (s) => { const t = Date.parse(String(s)); return Number.isFinite(t) ? t : null; };\n\nfor (const it of items) {\n  const r = it.json || {};\n  const x = toTs(r.fecha_hora);\n  const y = (r.precio != null) ? Number(r.precio) : null;\n  if (!x || !Number.isFinite(y)) continue;\n  const serie = String(r.serie || '').toLowerCase();\n  if (serie.startsWith('comp')) compra.push({ x, y });\n  else if (serie.startsWith('vent')) venta.push({ x, y });\n}\n\ncompra.sort((a,b)=>a.x-b.x);\nventa.sort((a,b)=>a.x-b.x);\n\nconst all = [...compra, ...venta].map(p => p.y);\nconst minY = all.length ? Math.min(...all) : 0;\nconst maxY = all.length ? Math.max(...all) : 1;\nconst padY = all.length ? Math.max((maxY - minY) * 0.10, 0.02) : 0.1;\n\nconst suggestedMin = +(minY - padY).toFixed(2);\nconst suggestedMax = +(maxY + padY).toFixed(2);\n\nconst last = arr => arr.length ? arr[arr.length - 1].y : null;\nconst first = arr => arr.length ? arr[0].y : null;\n\nconst lCompra = last(compra), fCompra = first(compra);\nconst lVenta  = last(venta),  fVenta  = first(venta);\nconst dCompra = (lCompra!=null && fCompra!=null) ? (lCompra - fCompra) : null;\nconst dVenta  = (lVenta!=null  && fVenta!=null ) ? (lVenta  - fVenta ) : null;\n\nconst p  = v => v==null ? 'â€“' : `$${v.toFixed(2)}`;\nconst pc = v => v==null ? ''  : (v>=0?`â–² +$${v.toFixed(2)}`:`â–¼ $${v.toFixed(2)}`);\n\nconst title = 'Precios P2P: Compra y Venta (BOB)';\nconst subtitle = `Ãšltimas 24h: ${fmt(start)} â†’ ${fmt(end)}`;\nconst caption = `${title}\\n${subtitle}\\nCompra: ${p(lCompra)} (${pc(dCompra)}) | Venta: ${p(lVenta)} (${pc(dVenta)})\\nRango 24h: ${p(minY)} â€“ ${p(maxY)}`;\n\nconst green = '#2ecc71', red = '#e74c3c';\n\nconst chartConfig = {\n  type: 'line',\n  data: {\n    datasets: [\n      { label:'Precio Compra', data:compra, borderColor:green, backgroundColor:green,\n        tension:0.2, pointRadius:2, pointHoverRadius:3, spanGaps:true },\n      { label:'Precio Venta',  data:venta,  borderColor:red,   backgroundColor:red,\n        tension:0.2, pointRadius:2, pointHoverRadius:3, spanGaps:true }\n    ]\n  },\n  options: {\n    parsing:false, animation:false,"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -272,
        144
      ],
      "id": "53c694ab-db33-4e8e-8140-e8e7e4a1c9e8",
      "name": "Code in JavaScript"
    }
  ],
  "connections": {
    "ğŸ•’ Manual Trigger": {
      "main": [
        [
          {
            "node": "ğŸ—„ï¸ MySQL â€“ Leer P2P 24h",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”— HTTP â€“ QuickChart /chart/create (short URL)": {
      "main": [
        [
          {
            "node": "ğŸ”€ Merge â€“ URL + Caption",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§¾ Set â€“ Caption (pass-through)": {
      "main": [
        [
          {
            "node": "ğŸ”€ Merge â€“ URL + Caption",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ğŸ”€ Merge â€“ URL + Caption": {
      "main": [
        [
          {
            "node": "ğŸ“¨ HTTP â€“ Evolution sendMedia (URL)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ—„ï¸ MySQL â€“ Leer P2P 24h": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "ğŸ”— HTTP â€“ QuickChart /chart/create (short URL)",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ§¾ Set â€“ Caption (pass-through)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "eb2e6f68-9c6a-4466-86b7-e2825e028d91",
  "triggerCount": 0,
  "shared": [
    {
      "updatedAt": "2025-10-01T21:15:06.433Z",
      "createdAt": "2025-10-01T21:15:06.433Z",
      "role": "workflow:owner",
      "workflowId": "8X2u0acz0kF9LKrz",
      "projectId": "DLCF6dMNvaWDIOVx"
    }
  ],
  "tags": []
}