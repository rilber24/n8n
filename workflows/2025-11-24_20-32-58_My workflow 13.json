{
  "updatedAt": "2025-09-04T19:10:09.000Z",
  "createdAt": "2025-09-03T22:22:31.429Z",
  "id": "KpUyQgjZGCyFIXEB",
  "name": "My workflow 13",
  "active": false,
  "isArchived": true,
  "nodes": [
    {
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "custom",
              "cronExpression": "10 22 * * *"
            }
          ]
        }
      },
      "id": "e595d646-d45b-4fee-9ff8-709fd0fd5161",
      "name": "Cron 22:10",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [
        -1392,
        64
      ]
    },
    {
      "parameters": {},
      "id": "7d222128-0025-4415-aae4-fcbbeea9d2bf",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1392,
        304
      ]
    },
    {
      "parameters": {
        "mode": "passThrough"
      },
      "id": "d7d4e573-2a98-416f-b4ab-9889f3f4fe1a",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 1,
      "position": [
        -1152,
        192
      ]
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "modo",
              "value": "text"
            },
            {
              "name": "message",
              "value": "Hola, {{fullName}}: ðŸ“£ Comunicado Ã¡rea {{areaId}} a las 10:30."
            },
            {
              "name": "mediaUrl"
            },
            {
              "name": "fileName",
              "value": "aviso.pdf"
            },
            {
              "name": "operatorTo",
              "value": "59172896612"
            },
            {
              "name": "overrideTo"
            },
            {
              "name": "evBase",
              "value": "={{$env.EV_BASE_URL}}"
            },
            {
              "name": "evInstance",
              "value": "={{$env.EV_INSTANCE}}"
            },
            {
              "name": "evApikey",
              "value": "={{$env.EV_APIKEY}}"
            }
          ],
          "number": [
            {
              "name": "areaId",
              "value": 3
            },
            {
              "name": "batchSize",
              "value": 25
            },
            {
              "name": "delaySeconds",
              "value": 0.6
            }
          ],
          "boolean": [
            {
              "name": "verifyNumber"
            }
          ]
        },
        "options": {}
      },
      "id": "44040255-38d7-45af-b896-0bf3078c6ac9",
      "name": "Set Params",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        -912,
        192
      ]
    },
    {
      "parameters": {
        "url": "={{ 'https://apirrhh.envibol.site/api/v1/N8n/GetUnidad/' + $json['areaId'] }}",
        "options": {}
      },
      "id": "7bb3c94f-d521-4b5f-8021-ece7ee1abd1f",
      "name": "HTTP GetUnidad",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        -672,
        192
      ]
    },
    {
      "parameters": {
        "functionCode": "\nconst input = $json;\nconst SP_NAME = 'Set Params';\nlet p = {};\ntry { const sp = $items(SP_NAME,0,0); if (sp && sp[0] && sp[0].json) p = sp[0].json; } catch {}\np = { areaId:p.areaId??null, modo:p.modo??'text', message:p.message??'Hola, {{fullName}}.', mediaUrl:p.mediaUrl??'', fileName:p.fileName??'adjunto.pdf', operatorTo:p.operatorTo??'', overrideTo:p.overrideTo??'', delaySeconds:p.delaySeconds??0.6, evBase:p.evBase??'', evInstance:p.evInstance??'', evApikey:p.evApikey??'' };\nif (!p.evBase || !p.evInstance || !p.evApikey) { throw new Error('Faltan credenciales Evolution (evBase/evInstance/evApikey).'); }\nconst onlyDigits = (s)=>String(s??'').replace(/\\D/g,'');\nconst toE164BO = (raw)=>{ let n=onlyDigits(raw); if(!n) return null; if(/^591\\d{8}$/.test(n)) return n; if(/^7\\d{8}$/.test(n)) return '591'+n; if(/^\\d{8}$/.test(n)) return '591'+n; const mm=n.match(/591\\d{8}/); return mm?mm[0]:null; };\nfunction render(tpl,ctx){ return String(tpl??'').replace(/{{\\s*([\\w.]+)\\s*}}/g,(_,k)=>{ const v=k.split('.').reduce((a,kk)=>(a&&a[kk]!==undefined)?a[kk]:'',ctx); return (v===null||v===undefined)?'':String(v); }).replace(/\\s+/g,' ').trim(); }\nif (input && input.succeeded===false) { throw new Error(`API GetUnidad fallÃ³: ${input.message||'sin mensaje'}`); }\nconst personas = Array.isArray(input?.data)?input.data: Array.isArray(input)?input: [];\nconst seen=new Set(); let recipients=[];\nfor (const person of personas){\n  const num = toE164BO(person.celular); if(!num || seen.has(num)) continue; seen.add(num);\n  const fullName=[person.nombre,person.apellidoPaterno,person.apellidoMaterno].filter(Boolean).join(' ').replace(/\\s+/g,' ').trim();\n  const ctx={...person, fullName, areaId:p.areaId};\n  let msg=render(p.message, ctx); if(p.overrideTo && String(p.overrideTo).trim()){ msg = `[TEST â€” Ãrea ${p.areaId}] ${msg}`; }\n  recipients.push({ json: { to: (p.overrideTo && String(p.overrideTo).trim()) ? onlyDigits(p.overrideTo) : num, modo:p.modo, message:msg, mediaUrl:p.mediaUrl, fileName:p.fileName, evBase:p.evBase, evInstance:p.evInstance, evApikey:p.evApikey, operatorTo:p.operatorTo, delaySeconds:p.delaySeconds, areaId:p.areaId, fullName, ci: person.ci ?? null }});\n}\nconst store=this.getWorkflowStaticData('global'); store.broadcast??={}; const broadcastId=`b_${Date.now()}`;\nstore.broadcast[broadcastId]={ areaId:p.areaId, total:recipients.length, sent:0, failed:0, invalid:0, startedAt:new Date().toISOString() };\nreturn recipients.map(it=>({ json:{...it.json, broadcastId} }));\n"
      },
      "id": "c1c15489-958d-4b38-9ecc-22395fdb1484",
      "name": "Function Expand",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -432,
        192
      ]
    },
    {
      "parameters": {
        "batchSize": "={{$items('Set Params',0,0)[0].json.batchSize}}",
        "options": {}
      },
      "id": "cdbfce18-9e4a-4e24-871b-8730b84de301",
      "name": "Split In Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 1,
      "position": [
        -192,
        192
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.modo}}",
              "value2": "text"
            }
          ]
        }
      },
      "id": "3da68244-5160-4c6c-b358-e027fc0b3e6a",
      "name": "IF Text",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        48,
        96
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.modo}}",
              "value2": "image"
            }
          ]
        }
      },
      "id": "5b5c216a-4fb7-4b65-aa5e-db088b81648a",
      "name": "IF Image",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        48,
        192
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.modo}}",
              "value2": "document"
            }
          ]
        }
      },
      "id": "c35d9ba9-843b-48ad-bd8f-6c75f1e356ff",
      "name": "IF Document",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        48,
        288
      ]
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "=={{ ($json.evBase || 'https://hooks.ril.serviciocliente.site')\n     .toString().trim().replace(/\\/+$/,'') + '/message/sendText/' + encodeURIComponent($json.evInstance) }}",
        "jsonParameters": true,
        "options": {},
        "bodyParametersJson": "=",
        "headerParametersJson": "=",
        "queryParametersJson": "="
      },
      "id": "eec34787-bfbd-4d6b-bb3c-ecb2adf853ba",
      "name": "Send Text (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        288,
        96
      ]
    },
    {
      "parameters": {
        "url": "={{$json.evBase}}/message/sendImage/{{$json.evInstance}}",
        "jsonParameters": true,
        "options": {},
        "headerParametersJson": "={{ JSON.stringify({ apikey: $json.evApikey, 'Content-Type': 'application/json' }) }}"
      },
      "id": "0344a131-b903-4259-a6aa-0d65dbc686e5",
      "name": "Send Image (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        288,
        192
      ]
    },
    {
      "parameters": {
        "url": "={{$json.evBase}}/message/sendFile/{{$json.evInstance}}",
        "jsonParameters": true,
        "options": {},
        "headerParametersJson": "={{ JSON.stringify({ apikey: $json.evApikey, 'Content-Type': 'application/json' }) }}"
      },
      "id": "4ae225e4-59f0-40bc-9dea-a2d3bedc46e4",
      "name": "Send Document (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        288,
        288
      ]
    },
    {
      "parameters": {
        "functionCode": "const s=this.getWorkflowStaticData('global'); const id=$json.broadcastId; const ok=($json.statusCode===undefined)||($json.statusCode>=200&&$json.statusCode<300); if(ok)s.broadcast[id].sent++; else s.broadcast[id].failed++; return items;"
      },
      "id": "0566f8e0-2f8b-4a4b-840c-26278666384d",
      "name": "Function Tally",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        528,
        192
      ]
    },
    {
      "parameters": {
        "amount": "={{$json.delaySeconds || 0.6}}",
        "unit": "seconds"
      },
      "id": "4b76f7f6-10e1-4044-a277-25d4255df0ef",
      "name": "Wait",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        768,
        192
      ],
      "webhookId": "56667caa-e570-4266-9edb-11ab9a08096e"
    },
    {
      "parameters": {
        "functionCode": "const s=this.getWorkflowStaticData('global'); const keys=Object.keys(s.broadcast||{}); if(!keys.length){ return [{json:{to:$items('Set Params',0,0)[0].json.operatorTo, message:'No hay mÃ©tricas registradas.'}}]; } const id=keys.sort().slice(-1)[0]; const m=s.broadcast[id]; m.finishedAt=new Date().toISOString(); m.durationSec=Math.round((new Date(m.finishedAt)-new Date(m.startedAt))/1000); const summary=`ðŸ“Š *Resumen envÃ­o Ã¡rea ${m.areaId}*\\nâ€¢ Total destinatarios: ${m.total}\\nâ€¢ Enviados OK: ${m.sent}\\nâ€¢ InvÃ¡lidos: ${m.invalid}\\nâ€¢ Fallidos: ${m.failed}\\nâ€¢ DuraciÃ³n: ${m.durationSec}s\\nâ€¢ ID: ${id}`; return [{json:{to:$items('Set Params',0,0)[0].json.operatorTo, message: summary}}];"
      },
      "id": "6cc6e2ea-b9a0-4f4f-aa68-b6aa84469060",
      "name": "Function Build Summary",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        48,
        448
      ]
    },
    {
      "parameters": {
        "url": "={{$items('Set Params',0,0)[0].json.evBase}}/message/sendText/{{$items('Set Params',0,0)[0].json.evInstance}}",
        "jsonParameters": true,
        "options": {},
        "headerParametersJson": "={{ JSON.stringify({ apikey: $items('Set Params',0,0)[0].json.evApikey, 'Content-Type': 'application/json' }) }}"
      },
      "id": "87ca8601-491f-48c9-8062-2e9e4b89ec9e",
      "name": "Send Summary (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        288,
        448
      ]
    },
    {
      "parameters": {
        "functionCode": "const s=this.getWorkflowStaticData('global'); s.broadcast={}; return items;"
      },
      "id": "28edce84-8419-4cf5-bfc3-9630e6940b41",
      "name": "Function Cleanup",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        528,
        448
      ]
    }
  ],
  "connections": {
    "Cron 22:10": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Triggers": {
      "main": [
        [
          {
            "node": "Set Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Params": {
      "main": [
        [
          {
            "node": "HTTP GetUnidad",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP GetUnidad": {
      "main": [
        [
          {
            "node": "Function Expand",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function Expand": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split In Batches": {
      "main": [
        [
          {
            "node": "IF Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Text": {
      "main": [
        [
          {
            "node": "Send Text (HTTP)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Image": {
      "main": [
        [
          {
            "node": "Send Image (HTTP)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF Document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Document": {
      "main": [
        [
          {
            "node": "Send Document (HTTP)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Text (HTTP)": {
      "main": [
        [
          {
            "node": "Function Tally",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Image (HTTP)": {
      "main": [
        [
          {
            "node": "Function Tally",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Document (HTTP)": {
      "main": [
        [
          {
            "node": "Function Tally",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function Tally": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function Build Summary": {
      "main": [
        [
          {
            "node": "Send Summary (HTTP)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Summary (HTTP)": {
      "main": [
        [
          {
            "node": "Function Cleanup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": {
    "global": {
      "broadcast": {
        "b_1756951801150": {
          "areaId": 3,
          "total": 8,
          "sent": 0,
          "failed": 0,
          "invalid": 0,
          "startedAt": "2025-09-04T02:10:01.150Z"
        }
      }
    }
  },
  "meta": null,
  "pinData": {
    "Cron 22:10": [
      {
        "json": {}
      }
    ],
    "Manual Trigger": [
      {
        "json": {}
      }
    ]
  },
  "versionId": "af16ee7e-1204-4298-957a-a9320467232f",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-09-03T22:22:31.435Z",
      "createdAt": "2025-09-03T22:22:31.435Z",
      "role": "workflow:owner",
      "workflowId": "KpUyQgjZGCyFIXEB",
      "projectId": "DLCF6dMNvaWDIOVx"
    }
  ],
  "tags": []
}