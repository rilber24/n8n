{
  "updatedAt": "2025-09-22T15:39:30.000Z",
  "createdAt": "2025-09-22T15:11:55.366Z",
  "id": "9tdp92ieXFYuaWPh",
  "name": "My workflow 46",
  "active": false,
  "isArchived": true,
  "nodes": [
    {
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "everyX",
              "value": 15,
              "unit": "minutes"
            }
          ]
        }
      },
      "id": "fe0b15d7-db9e-4b01-bab3-3ed74acc6a3a",
      "name": "Cron 15m",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [
        128,
        96
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://p2p.binance.com/bapi/c2c/v2/friendly/c2c/adv/search",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "page",
              "value": "1"
            },
            {
              "name": "rows",
              "value": "20"
            },
            {
              "name": "asset",
              "value": "USDT"
            },
            {
              "name": "fiat",
              "value": "BOB"
            },
            {
              "name": "tradeType",
              "value": "BUY"
            }
          ]
        },
        "options": {
          "timeout": 20000
        }
      },
      "id": "8ec47833-8b38-435c-80de-777496d72e78",
      "name": "HTTP BUY",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        336,
        -32
      ]
    },
    {
      "parameters": {
        "language": "JavaScript"
      },
      "id": "70c73f1f-e71c-46bd-a153-3c921ed0ec56",
      "name": "Code in JavaScript (map BUY)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        560,
        -32
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://p2p.binance.com/bapi/c2c/v2/friendly/c2c/adv/search",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "options": {
          "timeout": 20000
        }
      },
      "id": "e2c8a0b3-1f5e-4ceb-8235-3b35979ff3f4",
      "name": "HTTP SELL",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        336,
        208
      ]
    },
    {
      "parameters": {
        "language": "JavaScript"
      },
      "id": "cf47a373-eb03-4592-80b9-b9858796d53f",
      "name": "Code in JavaScript (map SELL)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        560,
        208
      ]
    },
    {
      "parameters": {},
      "id": "ba3b01ba-d367-4b36-baae-45287b659ee2",
      "name": "Merge BUY+SELL",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        784,
        96
      ]
    },
    {
      "parameters": {
        "language": "JavaScript"
      },
      "id": "9b6379b1-da9d-4dd2-9200-10d054847950",
      "name": "Code in JavaScript (pack payload)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1008,
        96
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH raw AS (\n  SELECT\n    btrim(d->>'advertiser_name')                    AS advertiser_name,\n    (d->>'trade_type')::p2p.trade_type_enum         AS trade_type,\n    (d->>'captured_at')::timestamptz                AS captured_at,\n    (d->>'price_bob')::numeric                      AS price_bob,\n    (d->>'available_usdt')::numeric                 AS available_usdt\n  FROM jsonb_array_elements($1::jsonb) AS d\n),\npick AS (\n  SELECT DISTINCT ON (advertiser_name, trade_type)\n         advertiser_name, trade_type, captured_at, price_bob, available_usdt\n  FROM raw\n  ORDER BY advertiser_name, trade_type, captured_at DESC\n),\nbuckets AS (\n  SELECT\n    advertiser_name,\n    trade_type,\n    captured_at,\n    price_bob,\n    available_usdt,\n    date_trunc('hour', captured_at)\n      + make_interval(mins => (floor(extract(minute from captured_at)/15)::int)*15) AS captured_15m\n  FROM pick\n)\nINSERT INTO p2p.p2p_offers_core\n  (captured_at, trade_type, advertiser_name, price_bob, available_usdt, captured_minute)\nSELECT captured_at, trade_type, advertiser_name, price_bob, available_usdt, captured_15m\nFROM buckets\nON CONFLICT ON CONSTRAINT uq_core_minute_side_name\nDO UPDATE SET\n  price_bob      = EXCLUDED.price_bob,\n  available_usdt = EXCLUDED.available_usdt,\n  captured_at    = GREATEST(p2p.p2p_offers_core.captured_at, EXCLUDED.captured_at),\n  captured_minute= EXCLUDED.captured_minute;",
        "options": {}
      },
      "id": "eca954b7-c97f-491b-b3fa-54fca4e5a271",
      "name": "Postgres (Execute Query, upsert 15m)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        1280,
        96
      ],
      "credentials": {
        "postgres": {
          "id": "V2jxq9F8BKdy0BeI",
          "name": "Postgres account"
        }
      }
    }
  ],
  "connections": {
    "Cron 15m": {
      "main": [
        [
          {
            "node": "HTTP BUY",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP SELL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP BUY": {
      "main": [
        [
          {
            "node": "Code in JavaScript (map BUY)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP SELL": {
      "main": [
        [
          {
            "node": "Code in JavaScript (map SELL)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript (map BUY)": {
      "main": [
        [
          {
            "node": "Merge BUY+SELL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript (map SELL)": {
      "main": [
        [
          {
            "node": "Merge BUY+SELL",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge BUY+SELL": {
      "main": [
        [
          {
            "node": "Code in JavaScript (pack payload)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript (pack payload)": {
      "main": [
        [
          {
            "node": "Postgres (Execute Query, upsert 15m)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "e6d4572a-932c-45a7-9a9d-0ed8e4cd6035",
  "triggerCount": 0,
  "shared": [
    {
      "updatedAt": "2025-09-22T15:11:55.369Z",
      "createdAt": "2025-09-22T15:11:55.369Z",
      "role": "workflow:owner",
      "workflowId": "9tdp92ieXFYuaWPh",
      "projectId": "DLCF6dMNvaWDIOVx"
    }
  ],
  "tags": []
}