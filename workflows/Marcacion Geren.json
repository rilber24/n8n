{
  "updatedAt": "2025-11-05T23:26:13.000Z",
  "createdAt": "2025-10-22T18:48:09.031Z",
  "id": "4oUBOQXUJeSu72dq",
  "name": "Marcacion Geren",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "baseUrl",
              "value": "https://jasper.envibol.site:8443/jasperserver/rest_v2/reports/Reports/ENVIBOL/RRHH/Asistencia.pdf"
            },
            {
              "name": "j_username",
              "value": "envibol"
            },
            {
              "name": "j_password",
              "value": "123456789"
            },
            {
              "name": "nombre_apellido",
              "value": "FERNANDO DARIO SALINAS FERNANDEZ"
            },
            {
              "name": "number",
              "value": "59167670158"
            }
          ]
        },
        "options": {}
      },
      "id": "f47d7daa-6540-4bba-aa03-57e5eeab20b6",
      "name": "Set Params2",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        320,
        576
      ]
    },
    {
      "parameters": {
        "functionCode": "// Calcula FECHA_INI y FECHA_FIN segÃºn el dÃ­a actual\n// Si estamos despuÃ©s del 19 â†’ periodo actual (20 este mes - 19 mes siguiente)\n// Si estamos antes del 20 â†’ periodo anterior (20 mes pasado - 19 este mes)\n\nconst out = [];\nconst item = items[0] ? items[0].json : {};\nconst baseUrl = item.baseUrl || \"https://jasper.envibol.site:8443/jasperserver/rest_v2/reports/Reports/ENVIBOL/RRHH/Asistencia.pdf\";\nconst username = item.j_username || \"envibol\";\nconst password = item.j_password || \"123456789\";\nconst nombre = (item.nombre_apellido || 'USUARIO').trim();\nconst ci = item.ci || '';\nlet number = (item.number || '').toString().trim();\n\nfunction pad(n){ return n < 10 ? '0'+n : ''+n; }\nfunction fmtDDMMYYYY(d){ return pad(d.getDate()) + '/' + pad(d.getMonth()+1) + '/' + d.getFullYear(); }\nfunction fmtYYYYMMDD(d){ return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()); }\n\nconst now = new Date();\nlet fechaIni, fechaFin;\n\n// --- LÃ“GICA DINÃMICA DE PERIODO ---\nif (now.getDate() >= 20) {\n  // DespuÃ©s del 19 â†’ nuevo periodo (20 mes actual â†’ 19 mes siguiente)\n  fechaIni = new Date(now.getFullYear(), now.getMonth(), 20);\n  fechaFin = new Date(now.getFullYear(), now.getMonth() + 1, 19);\n} else {\n  // Antes del 20 â†’ periodo anterior (20 mes anterior â†’ 19 mes actual)\n  fechaIni = new Date(now.getFullYear(), now.getMonth() - 1, 20);\n  fechaFin = new Date(now.getFullYear(), now.getMonth(), 19);\n}\n// -----------------------------------\n\nconst FECHA_INI = fmtYYYYMMDD(fechaIni);\nconst FECHA_FIN = fmtYYYYMMDD(fechaFin);\nconst FECHA_INI_DMY = fmtDDMMYYYY(fechaIni);\nconst FECHA_FIN_DMY = fmtDDMMYYYY(fechaFin);\n\n// Mes y aÃ±o para el tÃ­tulo: usamos mes de FECHA_INI\nconst meses = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];\nconst mesTitulo = meses[fechaIni.getMonth()];\nconst anioTitulo = fechaIni.getFullYear();\n\nconst nombreEncoded = encodeURIComponent(nombre);\nconst link = `${baseUrl}?j_username=${encodeURIComponent(username)}&j_password=${encodeURIComponent(password)}&fecha_inicio=${FECHA_INI}&fecha_fin=${FECHA_FIN}&nombre_apellido=${nombreEncoded}`;\n\n// Caption / mensaje\nconst caption = `ðŸ“¦ Reporte de Marcaciones â€” ${mesTitulo} ${anioTitulo} (${FECHA_INI_DMY} â€“ ${FECHA_FIN_DMY})\\n\\nðŸ‘‹ Hola, ${nombre},\\nestas son tus marcaciones\\n\\nAtentamente,\\nENVIBOL RRHH`;\n\n// FileName seguro\nconst safeName = nombre.replace(/\\s+/g, '_').replace(/[^a-zA-Z0-9_\\-]/g, '');\nconst fileName = `Asistencia_${safeName}_${FECHA_INI}_${FECHA_FIN}.pdf`;\n\nout.push({ json: {\n  link,\n  fecha_inicio: FECHA_INI,\n  fecha_fin: FECHA_FIN,\n  fecha_inicio_dmy: FECHA_INI_DMY,\n  fecha_fin_dmy: FECHA_FIN_DMY,\n  titulo_mes: `${mesTitulo} ${anioTitulo}`,\n  caption,\n  fileName,\n  number\n}});\n\nreturn out;"
      },
      "id": "488e1142-ad75-4797-9a37-51028c5ddb4d",
      "name": "Calc Fechas y Link1",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        544,
        576
      ]
    },
    {
      "parameters": {
        "url": "={{ $json.link }}",
        "options": {
          "allowUnauthorizedCerts": true
        }
      },
      "id": "b54e0d6c-5e82-4820-b7a2-51a5b8a83e3b",
      "name": "HTTP PDF (descargar)2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        768,
        576
      ]
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "# Toma el PDF descargado por HTTP Request (binary.data) y expone el Base64 en json.b64\nsalida = []\nfor item in _input.all():\n    binary = item.get('binary', {}).get('data', {})\n    # En algunas instalaciones n8n, binary es un dict con 'data' que ya es Base64\n    b64 = None\n    file_name = item.json.get('fileName') or 'document.pdf'\n    mime = item.json.get('mimeType') or 'application/pdf'\n\n    if isinstance(binary, dict):\n        # caso esperado: {'data': '<base64>', 'fileName': 'Asistencia.pdf', 'mimeType': 'application/pdf'}\n        b = binary.get('data')\n        if b:\n            b64 = b\n            file_name = binary.get('fileName') or file_name\n            mime = binary.get('mimeType') or mime\n    else:\n        # si binary es string (ya base64)\n        if binary:\n            b64 = binary\n\n    if not b64:\n        continue\n\n    out_json = dict(item.json or {})\n    out_json['b64'] = b64\n    out_json['fileName'] = file_name\n    out_json['mimeType'] = mime\n\n    salida.append({\"json\": out_json})\n\nreturn salida"
      },
      "id": "38d2e0e8-cbe9-4805-8d4f-539a0b332d9e",
      "name": "PDF a Base65",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        976,
        576
      ]
    },
    {
      "parameters": {
        "resource": "messages-api",
        "operation": "send-document",
        "instanceName": "={{ $node[\"Set Params2\"].json.evInstance || 'dsb' }}",
        "remoteJid": "={{ $json.number }}",
        "media": "={{ $json.b64.data }}",
        "caption": "={{ $json.caption }}",
        "fileName": "={{ $json.fileName }}",
        "options_message": {
          "delay": 6000
        }
      },
      "id": "eefd7024-4232-46e3-87fb-3d019f0850a5",
      "name": "Enviar documento (Evolution)2",
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        1152,
        576
      ],
      "credentials": {
        "evolutionApi": {
          "id": "XJQVidx6LSBrYrny",
          "name": "Dsbolivia"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "weeks",
              "triggerAtDay": [
                1,
                2,
                3,
                4,
                5
              ],
              "triggerAtHour": 21,
              "triggerAtMinute": 7
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        144,
        576
      ],
      "id": "38af5adc-3e88-488b-950a-246029849c7c",
      "name": "Schedule Trigger"
    }
  ],
  "connections": {
    "Set Params2": {
      "main": [
        [
          {
            "node": "Calc Fechas y Link1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calc Fechas y Link1": {
      "main": [
        [
          {
            "node": "HTTP PDF (descargar)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP PDF (descargar)2": {
      "main": [
        [
          {
            "node": "PDF a Base65",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PDF a Base65": {
      "main": [
        [
          {
            "node": "Enviar documento (Evolution)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Set Params2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": {
    "node:Schedule Trigger": {
      "recurrenceRules": []
    }
  },
  "meta": null,
  "pinData": {},
  "versionId": "1f3fe63c-a613-4f18-8792-aabf02dc16cf",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-10-22T18:48:09.035Z",
      "createdAt": "2025-10-22T18:48:09.035Z",
      "role": "workflow:owner",
      "workflowId": "4oUBOQXUJeSu72dq",
      "projectId": "DLCF6dMNvaWDIOVx"
    }
  ],
  "tags": []
}